rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // è¼”åŠ©å‡½æ•¸
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isCompanyUser() {
      return isAuthenticated() && 
             request.auth.token.email.matches('.*@dbyv\\.org$');
    }
    
    function isLeader() {
      // Leader åå–®ï¼ˆä¹‹å¾Œå¯ä»¥æ”¹æˆå¾ Firestore è®€å–ï¼‰
      let leaders = [
        'joeshi@dbyv.org'
      ];
      return isCompanyUser() && 
             request.auth.token.email in leaders;
    }
    
    function isOwner() {
      return resource.data.createdBy == request.auth.token.email;
    }
    
    function isNewOwner() {
      return request.resource.data.createdBy == request.auth.token.email;
    }
    
    // ============================================
    // Templatesï¼ˆè¡¨æ ¼å®šç¾©ï¼‰
    // ============================================
    match /templates/{templateId} {
      // æ‰€æœ‰å…¬å¸ç”¨æˆ¶å¯è®€å–
      allow read: if isCompanyUser();
      // åªæœ‰ Leader å¯å¯«å…¥
      allow create: if isLeader();
      allow update: if isLeader();
      allow delete: if isLeader();
      
      // ğŸ¦„ UNICORN: Template ç‰ˆæœ¬å¿«ç…§ subcollection
      match /versions/{version} {
        // æ‰€æœ‰å…¬å¸ç”¨æˆ¶å¯è®€å–ï¼ˆç”¨æ–¼é¡¯ç¤ºèˆŠ submission çš„ template çµæ§‹ï¼‰
        allow read: if isCompanyUser();
        // åªæœ‰ Leader å¯å¯«å…¥ï¼ˆé€é updateTemplate å‡½æ•¸ï¼‰
        allow create: if isLeader();
        // ç‰ˆæœ¬å¿«ç…§ä¸å¯ä¿®æ”¹æˆ–åˆªé™¤ï¼ˆimmutableï¼‰
        allow update: if false;
        allow delete: if false;
      }
    }
    
    // ============================================
    // ğŸ¦„ UNICORN: OptionSetsï¼ˆä¸‹æ‹‰é¸é …æ±  - Governed Dictionaryï¼‰
    // Meaning Layer - åªæœ‰ Cloud Functionï¼ˆAdmin SDKï¼‰å¯ä»¥å¯«å…¥
    // ============================================
    match /optionSets/{optionSetId} {
      // æ‰€æœ‰å…¬å¸ç”¨æˆ¶å¯è®€å–
      allow read: if isCompanyUser();
      // ğŸ¦„ UNICORN: ç¦æ­¢å®¢æˆ¶ç«¯ç›´æ¥å¯«å…¥
      // æ‰€æœ‰è®Šæ›´å¿…é ˆé€é optionRequests å·¥ä½œæµ
      // åªæœ‰ Cloud Functionï¼ˆAdmin SDKï¼‰å¯ä»¥å¯«å…¥
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
    
    // ============================================
    // ğŸ¦„ UNICORN: Option Requestsï¼ˆé¸é …è®Šæ›´ç”³è«‹ï¼‰
    // Workflow Layer - Leader å¯å»ºç«‹ï¼ŒAdmin é€é Cloud Function å¯©æ ¸
    // ============================================
    match /optionRequests/{requestId} {
      // å…¬å¸ç”¨æˆ¶å¯è®€å–ï¼ˆLeader çœ‹è‡ªå·±çš„ç”³è«‹ï¼ŒAdmin çœ‹æ‰€æœ‰ï¼‰
      allow read: if isCompanyUser();
      
      // Leader å¯ä»¥å»ºç«‹ pending ç‹€æ…‹çš„ç”³è«‹
      allow create: if isLeader() &&
                       request.resource.data.status == 'pending' &&
                       request.resource.data.requestedBy == request.auth.token.email;
      
      // ğŸ¦„ UNICORN: ç¦æ­¢å®¢æˆ¶ç«¯ç›´æ¥ update
      // å¯©æ ¸ï¼ˆpending â†’ approved/rejectedï¼‰å¿…é ˆé€é Cloud Function
      allow update: if false;
      
      // ä¸å…è¨±åˆªé™¤
      allow delete: if false;
    }
    
    // ============================================
    // ğŸ¦„ UNICORN: Option Aliasesï¼ˆåˆä½µæ˜ å°„ï¼‰
    // Derived View - åªæœ‰ Cloud Function å¯ä»¥å¯«å…¥
    // ============================================
    match /optionAliases/{aliasId} {
      // å…¬å¸ç”¨æˆ¶å¯è®€å–ï¼ˆç”¨æ–¼è§£ææ­·å²è³‡æ–™ä¸­çš„èˆŠ codeï¼‰
      allow read: if isCompanyUser();
      // ç¦æ­¢å®¢æˆ¶ç«¯å¯«å…¥
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
    
    // ============================================
    // Submissionsï¼ˆæäº¤è³‡æ–™ï¼‰
    // ğŸ¦„ UNICORN: Submission æ˜¯ä¸å¯è®Šäº‹ä»¶
    // ============================================
    match /submissions/{submissionId} {
      // åªèƒ½è®€å–è‡ªå·±çš„æäº¤
      allow read: if isCompanyUser() && isOwner();
      // å»ºç«‹æ™‚å¿…é ˆè¨­å®šè‡ªå·±ç‚º createdByï¼Œä¸”å¿…é ˆåŒ…å«å¿…è¦æ¬„ä½
      allow create: if isCompanyUser() && isNewOwner() &&
                       request.resource.data.templateId != null &&
                       request.resource.data.templateVersion != null &&
                       request.resource.data._status == 'ACTIVE';
      // ğŸ¦„ UNICORN: ç¦æ­¢å®¢æˆ¶ç«¯ç›´æ¥ update
      // ç‹€æ…‹è½‰æ›ï¼ˆACTIVE â†’ CANCELLEDï¼‰å¿…é ˆé€é Cloud Function
      allow update: if false;
      // ä¸å…è¨±åˆªé™¤
      allow delete: if false;
    }
    
    // ============================================
    // Leaders æŸ¥çœ‹æ‰€æœ‰ Submissionsï¼ˆåŒ¯å‡ºç”¨ï¼‰
    // ============================================
    match /submissions/{submissionId} {
      allow read: if isLeader();
    }
    
    // ============================================
    // ğŸ¦„ UNICORN: Audit Logsï¼ˆç¨€æ ¸è¨˜éŒ„ï¼‰
    // åªæœ‰ Cloud Functionï¼ˆAdmin SDKï¼‰å¯ä»¥å¯«å…¥
    // ============================================
    match /auditLogs/{logId} {
      // Leaders å¯è®€å–ç¨½æ ¸è¨˜éŒ„
      allow read: if isLeader();
      // ç¦æ­¢å®¢æˆ¶ç«¯å¯«å…¥ï¼ˆåªæœ‰ Admin SDK å¯ä»¥ï¼‰
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
    
    // ============================================
    // ğŸ¦„ UNICORN: Draft System (Sandbox Layer)
    // ============================================
    
    function isAdmin() {
      let admins = [
        'joeshi@dbyv.org'
      ];
      return isCompanyUser() && 
             request.auth.token.email in admins;
    }
    
    // ğŸ¦„ UNICORN: Superuserï¼ˆå¯æˆæ¬Šã€å¯è®€å–æ‰€æœ‰ç”¨æˆ¶è³‡æ–™ï¼‰
    function isSuperuser() {
      let superusers = [
        'tong@dbyv.org',
        'jason@dbyv.org',
        'joeshi@dbyv.org'
      ];
      return isCompanyUser() && 
             request.auth.token.email in superusers;
    }
    
    function isDraftOwner() {
      return resource.data.createdBy == request.auth.token.email;
    }
    
    function isDraftEditable() {
      // Can only edit if status is 'draft' or 'rejected'
      return resource.data.status == 'draft' || resource.data.status == 'rejected';
    }
    
    // ---------- OptionSet Drafts ----------
    match /optionSetDrafts/{draftId} {
      // Owner can read their own drafts, Admin can read all
      allow read: if isCompanyUser() && (isDraftOwner() || isAdmin());
      
      // Leader can create with draft status
      allow create: if isLeader() &&
                       request.resource.data.status == 'draft' &&
                       request.resource.data.createdBy == request.auth.token.email;
      
      // Owner can update only when draft is editable
      // Can submit for review (change status to pending_review)
      allow update: if isLeader() && isDraftOwner() && (
                       // Case 1: Editing content (only when editable)
                       (isDraftEditable() && request.resource.data.status in ['draft', 'pending_review']) ||
                       // Case 2: Submitting for review
                       (resource.data.status == 'draft' && request.resource.data.status == 'pending_review')
                    );
      
      // Owner can delete their own drafts (when not pending)
      allow delete: if isLeader() && isDraftOwner() && 
                       resource.data.status != 'pending_review';
    }
    
    // ---------- Template Drafts ----------
    match /templateDrafts/{draftId} {
      // Owner can read their own drafts, Admin can read all
      allow read: if isCompanyUser() && (isDraftOwner() || isAdmin());
      
      // Leader can create with draft status
      allow create: if isLeader() &&
                       request.resource.data.status == 'draft' &&
                       request.resource.data.createdBy == request.auth.token.email;
      
      // Owner can update only when draft is editable
      // Can submit for review (change status to pending_review)
      allow update: if isLeader() && isDraftOwner() && (
                       // Case 1: Editing content (only when editable)
                       (isDraftEditable() && request.resource.data.status in ['draft', 'pending_review']) ||
                       // Case 2: Submitting for review
                       (resource.data.status == 'draft' && request.resource.data.status == 'pending_review')
                    );
      
      // Owner can delete their own drafts (when not pending)
      allow delete: if isLeader() && isDraftOwner() && 
                       resource.data.status != 'pending_review';
    }
    
    // ============================================
    // ğŸ¦„ UNICORN: User Interaction Collections
    // ============================================
    
    // ---------- userFormStats ----------
    match /userFormStats/{statId} {
      // Superuser å¯è®€å–å…¨éƒ¨ï¼Œä¸€èˆ¬ç”¨æˆ¶åªèƒ½è®€å–è‡ªå·±çš„
      allow read: if isCompanyUser() && (
                     isSuperuser() ||
                     resource.data.userEmail == request.auth.token.email
                   );
      
      // åªèƒ½å»ºç«‹è‡ªå·±çš„ stats
      allow create: if isCompanyUser() &&
                       request.resource.data.userEmail == request.auth.token.email;
      
      // ğŸ¦„ UNICORN: æ›´æ–°åªèƒ½ç”± Cloud Function
      allow update: if false;
      allow delete: if false;
    }
    
    // ---------- formAccessRequests ----------
    match /formAccessRequests/{requestId} {
      // Superuser å¯è®€å–å…¨éƒ¨
      // ä¸€èˆ¬ç”¨æˆ¶ï¼šç”³è«‹è€… æˆ– è¡¨æ ¼æ“æœ‰è€…/ç®¡ç†è€… å¯è®€å–
      allow read: if isCompanyUser() && (
                     isSuperuser() ||
                     resource.data.requesterEmail == request.auth.token.email ||
                     resource.data.ownerEmail == request.auth.token.email ||
                     request.auth.token.email in resource.data.managerEmails
                   );
      
      // å»ºç«‹æ™‚ requesterEmail å¿…é ˆæ˜¯è‡ªå·±
      allow create: if isCompanyUser() &&
                       request.resource.data.requesterEmail == request.auth.token.email &&
                       request.resource.data.status == 'pending';
      
      // ğŸ¦„ UNICORN: å¯©æ ¸åªèƒ½ç”± Cloud Function
      allow update: if false;
      allow delete: if false;
    }
    
    // ---------- templateSuggestions ----------
    match /templateSuggestions/{suggestionId} {
      // Superuser å¯è®€å–å…¨éƒ¨
      // ä¸€èˆ¬ç”¨æˆ¶ï¼šå»ºè­°è€… å¯è®€å–è‡ªå·±çš„
      allow read: if isCompanyUser() && (
                     isSuperuser() ||
                     resource.data.suggesterEmail == request.auth.token.email
                   );
      
      // å»ºç«‹æ™‚ suggesterEmail å¿…é ˆæ˜¯è‡ªå·±
      allow create: if isCompanyUser() &&
                       request.resource.data.suggesterEmail == request.auth.token.email &&
                       request.resource.data.status == 'pending';
      
      // ğŸ¦„ UNICORN: å¯©æ ¸åªèƒ½ç”± Cloud Function
      allow update: if false;
      allow delete: if false;
    }
    
    // ---------- formNameRegistry ----------
    match /formNameRegistry/{nameId} {
      // Leader å’Œ Superuser å¯è®€å–
      allow read: if isLeader();
      
      // ğŸ¦„ UNICORN: åªæœ‰ Cloud Function å¯ä»¥å¯«å…¥
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}


