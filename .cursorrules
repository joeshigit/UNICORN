# ğŸ¦„ UNICORN COMPLIANCE â€” CURSOR RULES

You are designing a Firestore-based system following the Unicorn Architecture.
You MUST follow document-based, write-time decision principles.
You MUST NOT use SQL, spreadsheet, or GAS mental models.

---

## ğŸ¯ UNICORN ç³»çµ±æ ¸å¿ƒç›®æ¨™ï¼ˆMUST READ FIRSTï¼‰

UNICORN æ˜¯ä¸€å€‹**è³‡æ–™æ”¶é›†æ¨™æº–åŒ–ç³»çµ±**ï¼Œæœ‰ä¸‰å€‹æ ¸å¿ƒç›®æ¨™ï¼š

### ç›®æ¨™ 1ï¼šæ¨™æº–åŒ–å»ºè¡¨ï¼ˆStandardized Form Creationï¼‰

Leader å¯ä»¥é‡ç”¨ï¼š
- **é¸é …æ± ï¼ˆoptionSetsï¼‰**ï¼šçµ±ä¸€çš„é¸é …å®šç¾©ï¼Œå¦‚éƒ¨é–€ã€å­¸æ ¡ã€ç‹€æ…‹
- **åˆ†é¡ï¼ˆmoduleï¼‰**ï¼šçµ±ä¸€çš„è¡¨æ ¼åˆ†é¡ï¼Œå¦‚ã€Œè¡Œæ”¿ã€ã€Œæ•™å­¸ã€ã€Œäººäº‹ã€
- **å‹•ä½œï¼ˆactionï¼‰**ï¼šçµ±ä¸€çš„æ“ä½œé¡å‹ï¼Œå¦‚ã€Œå ±å‘Šã€ã€Œç”³è«‹ã€ã€Œç™»è¨˜ã€

é€™æ¨£æ‰€æœ‰è¡¨æ ¼ä½¿ç”¨ç›¸åŒçš„èªæ„ï¼Œè³‡æ–™å¯ä»¥è·¨è¡¨æ ¼æ¯”è¼ƒå’Œåˆ†æã€‚

### ç›®æ¨™ 2ï¼šæ‰å¹³åŒ–è³‡æ–™çµæ§‹ï¼ˆFlat Data Structureï¼‰â€” Universal KEY è¨­è¨ˆ

UNICORN æ¡ç”¨ **Universal KEY** è¨­è¨ˆï¼š

#### KEY vs LABEL vs VALUE

| æ¦‚å¿µ | èªªæ˜ | ç¯„ä¾‹ |
|------|------|------|
| **KEY** | ç³»çµ±çµ±ä¸€çš„æ¬„ä½åç¨±ï¼Œè·¨æ‰€æœ‰è¡¨æ ¼ç›¸åŒ | `school`, `startDateTime`, `quantity1` |
| **LABEL** | UI é¡¯ç¤ºåç¨±ï¼ŒLeader è‡ªç”±è¨­è¨ˆ | ã€Œå…¥ç‡Ÿå­¸æ ¡ã€ã€Œé§å®ˆå­¸æ ¡ã€ã€Œç™¼ä¿¡å­¸æ ¡ã€ |
| **VALUE** | æ¨™æº–åŒ–çš„å€¼ï¼Œä¾†è‡ª optionSet | `ç²µè¯ä¸­å­¸`ï¼ˆä¸æ˜¯ã€Œç²µè¯ã€ã€Œç²µè¯å­¸æ ¡ã€ï¼‰ |

#### Universal Keysï¼ˆç³»çµ±å›ºå®šçš„æ¬„ä½ KEYï¼‰

| KEY | é¡å‹ | èªªæ˜ |
|-----|------|------|
| `school` | optionSet | å­¸æ ¡ |
| `service` | optionSet | æœå‹™é¡å‹ |
| `project` | optionSet | é …ç›® |
| `format` | optionSet | æ ¼å¼ |
| `action` | optionSet | å‹•ä½œé¡å‹ |
| `startDateTime` | datetime | é–‹å§‹æ™‚é–“ï¼ˆyyyymmdd hh:mmï¼‰ |
| `endDateTime` | datetime | çµæŸæ™‚é–“ï¼ˆyyyymmdd hh:mmï¼‰ |
| `quantity1` | number | æ•¸é‡1 |
| `quantity2` | number | æ•¸é‡2 |
| `quantity3` | number | æ•¸é‡3 |
| `notes1` | text | å‚™è¨»ï¼ˆå–®è¡Œï¼‰ |
| `notes2` | textarea | å‚™è¨»ï¼ˆå¤šè¡Œï¼‰ |

#### è³‡æ–™çµæ§‹ç¯„ä¾‹

```javascript
// âœ… æ­£ç¢ºï¼šUniversal KEY è¨­è¨ˆ
{
  // ===== ç³»çµ± Metadataï¼ˆ_ å‰ç¶´ï¼‰=====
  _templateId: "template_camp_register",
  _templateModule: "CAMP",
  _templateAction: "REGISTER",
  _templateVersion: 1,
  _submitterId: "staff@org.com",
  _submittedAt: Timestamp,
  _submittedMonth: "2026-01",
  _status: "ACTIVE",
  
  // ===== ç”¨æˆ¶è³‡æ–™ï¼ˆUniversal KEY: VALUEï¼‰=====
  school: "ç²µè¯ä¸­å­¸",              // KEY çµ±ä¸€ï¼ŒVALUE ä¾†è‡ª optionSet
  startDateTime: "20260115 09:00", // KEY çµ±ä¸€ï¼Œæ ¼å¼å›ºå®š
  endDateTime: "20260117 16:00",
  quantity1: 30,
  notes1: "éœ€è¦ç´ é£Ÿé¤",
  
  // ===== æ¬„ä½ LABEL å¿«ç…§ï¼ˆé¡¯ç¤ºç”¨ï¼‰=====
  _fieldLabels: {
    school: "å…¥ç‡Ÿå­¸æ ¡",            // é€™å€‹è¡¨æ ¼å«ã€Œå…¥ç‡Ÿå­¸æ ¡ã€
    startDateTime: "å…¥ç‡Ÿæ™‚é–“",
    endDateTime: "é€€ç‡Ÿæ™‚é–“",
    quantity1: "å­¸ç”Ÿäººæ•¸",
    notes1: "ç‰¹æ®Šéœ€æ±‚"
  },
  
  // ===== é¸é … LABEL å¿«ç…§ï¼ˆå¦‚æœ value â‰  labelï¼‰=====
  _optionLabels: {
    school: "ç²µè¯ä¸­å­¸"             // é¸é …çš„é¡¯ç¤ºåç¨±
  },
  
  // ===== æª”æ¡ˆ =====
  files: [...]
}

// âŒ éŒ¯èª¤ï¼šå·¢ç‹€çµæ§‹
{
  _templateId: "template_xyz",
  values: {
    school: "ç²µè¯ä¸­å­¸"            // å·¢ç‹€é•å Firestore æœ€ä½³å¯¦è¸
  }
}

// âŒ éŒ¯èª¤ï¼šè‡ªå®šç¾© KEY
{
  å…¥ç‡Ÿå­¸æ ¡: "ç²µè¯ä¸­å­¸",            // KEY ä¸èƒ½æ˜¯ä¸­æ–‡æˆ–è‡ªå®šç¾©åç¨±
  campSchool: "ç²µè¯ä¸­å­¸"          // KEY å¿…é ˆç”¨ Universal KEY
}
```

#### ç‚ºä»€éº¼ç”¨ Universal KEYï¼Ÿ

1. **è·¨è¡¨æŸ¥è©¢ä¸€è‡´**ï¼šæ‰€æœ‰è¡¨æ ¼çš„ `school` éƒ½æ˜¯åŒä¸€å€‹ KEYï¼Œç›´æ¥æŸ¥è©¢
2. **ä¸éœ€è¦æ¬„ä½æ˜ å°„**ï¼šä¸éœ€è¦ `_query*` å‰ç¶´ï¼ŒKEY æœ¬èº«å°±æ˜¯æŸ¥è©¢æ¬„ä½
3. **LABEL éˆæ´»**ï¼šä¸åŒè¡¨æ ¼å¯ç”¨ä¸åŒ LABELï¼Œä¸å½±éŸ¿è³‡æ–™æŸ¥è©¢
4. **VALUE æ¨™æº–åŒ–**ï¼šé€é optionSet å¼·åˆ¶çµ±ä¸€ï¼Œé¿å…ã€Œç²µè¯ã€ã€Œç²µè¯ä¸­å­¸ã€ä¸ä¸€è‡´

#### Master/Subset OptionSet è¨­è¨ˆ

åŒä¸€å€‹ Universal KEY å¯ä»¥æœ‰å¤šå€‹ OptionSetï¼ˆå­é›†ï¼‰ï¼š

```javascript
// Master OptionSetï¼ˆå®Œæ•´æ¸…å–®ï¼Œ100 å€‹å­¸æ ¡ï¼‰
{
  code: "school",
  name: "æ‰€æœ‰å­¸æ ¡",
  isMaster: true,
  items: [/* 100 å€‹å­¸æ ¡ */]
}

// Subset Aï¼ˆä¸­å­¸ï¼Œ50 å€‹ï¼‰
{
  code: "school",           // åŒä¸€å€‹ KEY
  name: "ä¸­å­¸",
  isMaster: false,
  masterSetId: "school_master",
  items: [/* 50 å€‹ä¸­å­¸ï¼Œå¿…é ˆå­˜åœ¨æ–¼ Master */]
}

// Subset Bï¼ˆæ•™æœƒå°å­¸ï¼Œ20 å€‹ï¼‰
{
  code: "school",           // åŒä¸€å€‹ KEY
  name: "æ•™æœƒå°å­¸",
  isMaster: false,
  masterSetId: "school_master",
  items: [/* 20 å€‹æ•™æœƒå°å­¸ï¼Œå¿…é ˆå­˜åœ¨æ–¼ Master */]
}
```

**è¦å‰‡**ï¼š
- å¤šå€‹ OptionSet å¯ä»¥å…±ç”¨åŒä¸€å€‹ `code`ï¼ˆUniversal KEYï¼‰
- `isMaster: true` = å®Œæ•´æ¸…å–®ï¼Œ`isMaster: false` = å­é›†
- å­é›†çš„ `masterSetId` æŒ‡å‘ Master çš„ ID
- å­é›†çš„æ¯å€‹ `value` å¿…é ˆå­˜åœ¨æ–¼ Master ä¸­
- æ–°å¢é¸é …åªèƒ½åœ¨ Master ä¸­é€²è¡Œ
- ä¸ç®¡ç”¨å“ªå€‹å­é›†ï¼Œsubmission å­˜çš„ VALUE éƒ½æ˜¯æ¨™æº–åŒ–çš„

**æŸ¥è©¢ä¸å—å½±éŸ¿**ï¼š
```javascript
// ä¸ç®¡æ˜¯ç”¨ã€Œä¸­å­¸ã€é‚„æ˜¯ã€Œæ•™æœƒå°å­¸ã€å­é›†æäº¤
// æŸ¥è©¢éƒ½ä¸€æ¨£æœ‰æ•ˆ
db.collection('submissions')
  .where('school', '==', 'ç²µè¯ä¸­å­¸')
```

### ç›®æ¨™ 3ï¼šå–®ä¸€è³‡æ–™æ± ï¼ˆSingle Data Poolï¼‰

æ‰€æœ‰è¡¨æ ¼çš„æäº¤éƒ½å­˜åœ¨åŒä¸€å€‹ `submissions` collectionï¼š
- **ä¸æ˜¯** `submissions_formA`, `submissions_formB` åˆ†é–‹å­˜
- **æ˜¯** çµ±ä¸€çš„ `submissions` è³‡æ–™æ± 
- å¯ä»¥è·¨è¡¨æ ¼æŸ¥è©¢å’Œçµ±è¨ˆ

```javascript
// è·¨æ‰€æœ‰è¡¨æ ¼æŸ¥è©¢ã€Œç²µè¯ä¸­å­¸ã€çš„è³‡æ–™
db.collection('submissions')
  .where('school', '==', 'ç²µè¯ä¸­å­¸')

// æŸ¥è©¢ç‰¹å®šé¡å‹çš„è¡¨æ ¼
db.collection('submissions')
  .where('_templateModule', '==', 'CAMP')

// æŒ‰æœˆä»½çµ±è¨ˆæ‰€æœ‰æäº¤
db.collection('submissions')
  .where('_submittedMonth', '==', '2026-01')

// çµ„åˆæŸ¥è©¢ï¼šCAMP é¡ + ç²µè¯ä¸­å­¸ + 2026å¹´1æœˆ
db.collection('submissions')
  .where('_templateModule', '==', 'CAMP')
  .where('school', '==', 'ç²µè¯ä¸­å­¸')
  .where('_submittedMonth', '==', '2026-01')
```

**è·¨è¡¨æŸ¥è©¢çš„é—œéµ**ï¼šä½¿ç”¨ Universal KEYï¼ˆå¦‚ `school`ï¼‰ï¼Œä¸æ˜¯ LABELï¼ˆå¦‚ã€Œå…¥ç‡Ÿå­¸æ ¡ã€ï¼‰ã€‚

### ğŸ¦„ é€™å°±æ˜¯ UNICORN çš„åƒ¹å€¼

| å‚³çµ±ç³»çµ± | UNICORN ç³»çµ± |
|---------|-------------|
| æ¯å€‹è¡¨æ ¼ä¸€å€‹è³‡æ–™è¡¨ | çµ±ä¸€çš„ submissions è³‡æ–™æ±  |
| è³‡æ–™åˆ†æ•£ï¼Œç„¡æ³•è·¨è¡¨æŸ¥è©¢ | å–®ä¸€æ± ï¼Œå¯è·¨è¡¨æ ¼æŸ¥è©¢ |
| æ¯å€‹è¡¨æ ¼å®šç¾©è‡ªå·±çš„é¸é … | å…±ç”¨é¸é …æ± ï¼Œèªæ„ä¸€è‡´ |
| æ¬„ä½åç¨±ä¸ä¸€è‡´ï¼ˆdept, department, unitï¼‰ | Universal KEY çµ±ä¸€ï¼ˆschoolï¼‰ |
| æŸ¥è©¢éœ€è¦ JOIN å¤šå€‹è¡¨ | ç›´æ¥æŸ¥è©¢ï¼Œç„¡éœ€ JOIN |

---

## Before Any Design Output

### Step 1 â€” Identify Layers
Label every collection as one of:
- Meaning (Dictionary)
- Template  
- Submission
- Derived View

If a collection does not clearly fit â†’ redesign.

### Step 2 â€” Verify (All must be YES)
1. All important decisions stored as fields?
2. Zero read-time computation?
3. Submissions immutable?
4. Templates are data, not code?
5. UI queries without joins?
6. Duplication intentionally accepted?
7. Analytics separated from operations?

If any answer is NO â†’ fix the design before continuing.

### Step 3 â€” Forbidden Patterns
REJECT any design with:
- SQL joins
- Spreadsheet formulas
- "Compute this later"
- Read-time aggregation
- Subcollections used as relational tables
- UI recalculating historical truth
- Custom field keys (must use Universal KEYs)

If any are present â†’ redesign.

### Step 4 â€” Write-Time Decision (Required)
For each derived value, MUST explain:
- When it is computed
- Who computes it (UI or Cloud Function)
- Where it is stored
- When it becomes locked

No explanation â†’ invalid design.

---

## Key Anti-Patterns to Avoid

### âŒ Spreadsheet Thinking
WRONG: "Store raw data, compute on query"
CORRECT: Compute at save time, store results, query stored fields

### âŒ SQL Join Simulation
WRONG: applications â†’ persons â†’ interviews â†’ payroll
CORRECT: Snapshot data into documents, treat as immutable events

### âŒ Subcollections as Tables
WRONG: persons/{id}/applications/{appId}
CORRECT: applications/{appId} with personId field

### âŒ UI Doing Final Decisions
WRONG: UI calculates and saves final values
CORRECT: UI previews, Cloud Function finalizes

### âŒ Mixed Lifecycle in One Document
WRONG: status = "draft | submitted | approved | rejected | paid"
CORRECT: Separate documents for each lifecycle stage

### âŒ Date Math in Queries
WRONG: Query date ranges and sum
CORRECT: Store _submittedMonth = "YYYY-MM", query by month

### âŒ Custom Field Keys
WRONG: Leader defines arbitrary field keys like "campSchool", "å…¥ç‡Ÿå­¸æ ¡"
CORRECT: Leader selects from Universal KEYs (school, startDateTime, quantity1, etc.)

---

## What Makes This a Unicorn

Most systems:
- Store raw data
- Recompute endlessly
- Break over time
- Allow inconsistent field names

This system:
- Captures decisions at write-time
- Freezes truth
- Separates collection vs computation
- Leaders define meaning without engineers
- Universal KEYs ensure query consistency

---

## Reference
For complete validation checklist (18 sections), see:
unicorn-dcs/UNICORN SYSTEM â€” COMPLETE VALIDATION CHECKLIST.md

