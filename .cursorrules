# ğŸ¦„ UNICORN COMPLIANCE â€” CURSOR RULES

You are designing a Firestore-based system following the Unicorn Architecture.
You MUST follow document-based, write-time decision principles.
You MUST NOT use SQL, spreadsheet, or GAS mental models.

---

## ğŸ¯ UNICORN ç³»çµ±æ ¸å¿ƒç›®æ¨™ï¼ˆMUST READ FIRSTï¼‰

UNICORN æ˜¯ä¸€å€‹**è³‡æ–™æ”¶é›†æ¨™æº–åŒ–ç³»çµ±**ï¼Œæœ‰ä¸‰å€‹æ ¸å¿ƒç›®æ¨™ï¼š

### ç›®æ¨™ 1ï¼šæ¨™æº–åŒ–å»ºè¡¨ï¼ˆStandardized Form Creationï¼‰

Leader å¯ä»¥é‡ç”¨ï¼š
- **é¸é …æ± ï¼ˆoptionSetsï¼‰**ï¼šçµ±ä¸€çš„é¸é …å®šç¾©ï¼Œå¦‚éƒ¨é–€ã€å­¸æ ¡ã€ç‹€æ…‹
- **åˆ†é¡ï¼ˆmoduleï¼‰**ï¼šçµ±ä¸€çš„è¡¨æ ¼åˆ†é¡ï¼Œå¦‚ã€Œè¡Œæ”¿ã€ã€Œæ•™å­¸ã€ã€Œäººäº‹ã€
- **å‹•ä½œï¼ˆactionï¼‰**ï¼šçµ±ä¸€çš„æ“ä½œé¡å‹ï¼Œå¦‚ã€Œå ±å‘Šã€ã€Œç”³è«‹ã€ã€Œç™»è¨˜ã€

é€™æ¨£æ‰€æœ‰è¡¨æ ¼ä½¿ç”¨ç›¸åŒçš„èªæ„ï¼Œè³‡æ–™å¯ä»¥è·¨è¡¨æ ¼æ¯”è¼ƒå’Œåˆ†æã€‚

### ç›®æ¨™ 2ï¼šæ‰å¹³åŒ–è³‡æ–™çµæ§‹ï¼ˆFlat Data Structureï¼‰â€” Hybrid åˆ†å€æ‰å¹³

æ¯å€‹ submission æ¡ç”¨ **Hybrid åˆ†å€æ‰å¹³** è¨­è¨ˆï¼Œå…¼é¡§ã€Œè·¨è¡¨æŸ¥è©¢ç©©å®šæ€§ã€èˆ‡ã€Œè¡¨å–®è‡ªç”±åº¦ã€ï¼š

```javascript
// âœ… æ­£ç¢ºï¼šHybrid åˆ†å€æ‰å¹³çµæ§‹
{
  // ===== ç³»çµ± Metadataï¼ˆ_ å‰ç¶´ï¼Œå¿…é ˆæœ‰ï¼Œæœ‰ç´¢å¼•ï¼‰=====
  _templateId: "template_xyz",
  _templateCode: "MONTHLY_REPORT",
  _templateModule: "è¡Œæ”¿",           // æ¨™æº–åŒ–åˆ†é¡
  _templateAction: "å ±å‘Š",           // æ¨™æº–åŒ–å‹•ä½œ
  _templateVersion: 1,
  _submitterId: "user_001",
  _submitterEmail: "staff@org.com",
  _submittedAt: Timestamp,
  _submittedMonth: "2026-01",        // æœˆä»½ç´¢å¼•
  
  // ===== æ¨™æº–åŒ–æŸ¥è©¢æ¬„ä½ï¼ˆ_query å‰ç¶´ï¼ŒCloud Function å¯«å…¥æ™‚è¨ˆç®—ï¼‰=====
  _queryDepartment: "HR",            // è·¨è¡¨æŸ¥è©¢ç”¨ï¼Œå¾ optionSet æ¨™æº–åŒ–
  _queryStatus: "completed",         // è·¨è¡¨æŸ¥è©¢ç”¨
  _querySchool: "SCH001",            // è·¨è¡¨æŸ¥è©¢ç”¨
  
  // ===== ç”¨æˆ¶å¡«å¯«è³‡æ–™ï¼ˆé ‚å±¤ï¼Œé¡¯ç¤ºç”¨ï¼Œå¯èƒ½æ²’ç´¢å¼•ï¼‰=====
  department: "HR",
  reportTitle: "2026å¹´1æœˆå·¥ä½œå ±å‘Š",
  content: "æœ¬æœˆå®Œæˆ...",
  customField: "any value",
  
  // ===== é¡¯ç¤ºç”¨å¿«ç…§ =====
  _labelSnapshots: {
    department: "äººåŠ›è³‡æºéƒ¨",
    _querySchool: "å°åŒ—ç¬¬ä¸€å­¸æ ¡"
  }
}

// âŒ éŒ¯èª¤ï¼šå·¢ç‹€çµæ§‹
{
  _templateId: "template_xyz",
  data: {
    department: "HR"          // å·¢ç‹€é•å Firestore æœ€ä½³å¯¦è¸
  }
}
```

**Hybrid åˆ†å€æ‰å¹³åŸå‰‡**ï¼š

| å±¤ç´š | å‰ç¶´ | ç”¨é€” | ç´¢å¼• |
|------|-----|------|------|
| ç³»çµ± Metadata | `_` | è¿½è¹¤ã€å¯©è¨ˆã€ç‰ˆæœ¬ | âœ… å¿…æœ‰ |
| æ¨™æº–åŒ–æŸ¥è©¢æ¬„ä½ | `_query` | è·¨è¡¨åˆ†æã€å ±è¡¨ | âœ… å¿…æœ‰ |
| ç”¨æˆ¶è³‡æ–™æ¬„ä½ | ç„¡å‰ç¶´ | é¡¯ç¤ºã€å–®è¡¨æŸ¥è©¢ | âš ï¸ è¦–éœ€æ±‚ |
| é¡¯ç¤ºå¿«ç…§ | `_labelSnapshots` | æ­·å²æ¨™ç±¤é¡¯ç¤º | âŒ ç„¡ |

**ç‚ºä»€éº¼ç”¨ Hybridï¼Ÿ**
1. **é¿å…ç´¢å¼•çˆ†ç‚¸**ï¼šFirestore è¤‡åˆç´¢å¼•ä¸Šé™ 200 å€‹ï¼Œ`_query*` æ¬„ä½æ•¸é‡å¯æ§
2. **ä¿è­‰è·¨è¡¨æŸ¥è©¢**ï¼šä¸ç®¡ Leader æŠŠæ¬„ä½å« `dept` é‚„æ˜¯ `department`ï¼Œåªè¦å°æ‡‰åˆ° `_queryDepartment`ï¼Œè·¨è¡¨æŸ¥è©¢å°±ä¸€è‡´
3. **ä¿ç•™è¡¨å–®è‡ªç”±åº¦**ï¼šç”¨æˆ¶æ¬„ä½ä»åœ¨é ‚å±¤ï¼Œç°¡å–®æŸ¥è©¢ä»å¯ç”¨
4. **ç¬¦åˆ Firestore å¤©æ€§**ï¼šCloud Function åœ¨å¯«å…¥æ™‚è¨ˆç®—ï¼Œè®€å–æ™‚é›¶è¨ˆç®—

**è¦å‰‡**ï¼š
- ç³»çµ±æ¬„ä½ç”¨ `_` å‰ç¶´ï¼ˆå¦‚ `_templateId`, `_submittedAt`ï¼‰
- æ¨™æº–åŒ–æŸ¥è©¢æ¬„ä½ç”¨ `_query` å‰ç¶´ï¼ˆå¦‚ `_queryDepartment`ï¼‰
- ç”¨æˆ¶è³‡æ–™æ¬„ä½ç›´æ¥æ”¾é ‚å±¤ï¼Œç„¡å‰ç¶´ï¼ˆå¦‚ `department`, `status`ï¼‰
- å»ºç«‹è¡¨æ ¼æ™‚é©—è­‰æ¬„ä½åç¨±ä¸èƒ½ä»¥ `_` é–‹é ­
- `_query*` æ¬„ä½ç”± Cloud Function åœ¨ submission å¯«å…¥æ™‚è‡ªå‹•è¨ˆç®—

### ç›®æ¨™ 3ï¼šå–®ä¸€è³‡æ–™æ± ï¼ˆSingle Data Poolï¼‰

æ‰€æœ‰è¡¨æ ¼çš„æäº¤éƒ½å­˜åœ¨åŒä¸€å€‹ `submissions` collectionï¼š
- **ä¸æ˜¯** `submissions_formA`, `submissions_formB` åˆ†é–‹å­˜
- **æ˜¯** çµ±ä¸€çš„ `submissions` è³‡æ–™æ± 
- å¯ä»¥è·¨è¡¨æ ¼æŸ¥è©¢å’Œçµ±è¨ˆ

```javascript
// è·¨æ‰€æœ‰è¡¨æ ¼æŸ¥è©¢ HR éƒ¨é–€çš„è³‡æ–™ï¼ˆç”¨æ¨™æº–åŒ–æ¬„ä½ï¼‰
db.collection('submissions')
  .where('_queryDepartment', '==', 'HR')

// æŸ¥è©¢ç‰¹å®šé¡å‹çš„è¡¨æ ¼
db.collection('submissions')
  .where('_templateModule', '==', 'è¡Œæ”¿')

// æŒ‰æœˆä»½çµ±è¨ˆæ‰€æœ‰æäº¤
db.collection('submissions')
  .where('_submittedMonth', '==', '2026-01')

// çµ„åˆæŸ¥è©¢ï¼šè¡Œæ”¿é¡ + HR éƒ¨é–€ + 2026å¹´1æœˆ
db.collection('submissions')
  .where('_templateModule', '==', 'è¡Œæ”¿')
  .where('_queryDepartment', '==', 'HR')
  .where('_submittedMonth', '==', '2026-01')
```

**è·¨è¡¨æŸ¥è©¢çš„é—œéµ**ï¼šä½¿ç”¨ `_query*` æ¨™æº–åŒ–æ¬„ä½ï¼Œè€Œéç”¨æˆ¶è‡ªå®šç¾©æ¬„ä½åç¨±ã€‚

### ğŸ¦„ é€™å°±æ˜¯ UNICORN çš„åƒ¹å€¼

| å‚³çµ±ç³»çµ± | UNICORN ç³»çµ± |
|---------|-------------|
| æ¯å€‹è¡¨æ ¼ä¸€å€‹è³‡æ–™è¡¨ | çµ±ä¸€çš„ submissions è³‡æ–™æ±  |
| è³‡æ–™åˆ†æ•£ï¼Œç„¡æ³•è·¨è¡¨æŸ¥è©¢ | å–®ä¸€æ± ï¼Œå¯è·¨è¡¨æ ¼æŸ¥è©¢ |
| æ¯å€‹è¡¨æ ¼å®šç¾©è‡ªå·±çš„é¸é … | å…±ç”¨é¸é …æ± ï¼Œèªæ„ä¸€è‡´ |
| æŸ¥è©¢éœ€è¦ JOIN å¤šå€‹è¡¨ | ç›´æ¥æŸ¥è©¢ï¼Œç„¡éœ€ JOIN |

---

## Before Any Design Output

### Step 1 â€” Identify Layers
Label every collection as one of:
- Meaning (Dictionary)
- Template  
- Submission
- Derived View

If a collection does not clearly fit â†’ redesign.

### Step 2 â€” Verify (All must be YES)
1. All important decisions stored as fields?
2. Zero read-time computation?
3. Submissions immutable?
4. Templates are data, not code?
5. UI queries without joins?
6. Duplication intentionally accepted?
7. Analytics separated from operations?

If any answer is NO â†’ fix the design before continuing.

### Step 3 â€” Forbidden Patterns
REJECT any design with:
- SQL joins
- Spreadsheet formulas
- "Compute this later"
- Read-time aggregation
- Subcollections used as relational tables
- UI recalculating historical truth

If any are present â†’ redesign.

### Step 4 â€” Write-Time Decision (Required)
For each derived value, MUST explain:
- When it is computed
- Who computes it (UI or Cloud Function)
- Where it is stored
- When it becomes locked

No explanation â†’ invalid design.

---

## Key Anti-Patterns to Avoid

### âŒ Spreadsheet Thinking
WRONG: "Store raw data, compute on query"
CORRECT: Compute at save time, store results, query stored fields

### âŒ SQL Join Simulation
WRONG: applications â†’ persons â†’ interviews â†’ payroll
CORRECT: Snapshot data into documents, treat as immutable events

### âŒ Subcollections as Tables
WRONG: persons/{id}/applications/{appId}
CORRECT: applications/{appId} with personId field

### âŒ UI Doing Final Decisions
WRONG: UI calculates and saves final values
CORRECT: UI previews, Cloud Function finalizes

### âŒ Mixed Lifecycle in One Document
WRONG: status = "draft | submitted | approved | rejected | paid"
CORRECT: Separate documents for each lifecycle stage

### âŒ Date Math in Queries
WRONG: Query date ranges and sum
CORRECT: Store _month = "YYYY-MM", query by month

---

## What Makes This a Unicorn

Most systems:
- Store raw data
- Recompute endlessly
- Break over time

This system:
- Captures decisions at write-time
- Freezes truth
- Separates collection vs computation
- Leaders define meaning without engineers

---

## Reference
For complete validation checklist (18 sections), see:
unicorn-dcs/UNICORN SYSTEM â€” COMPLETE VALIDATION CHECKLIST.md


